<!-- Copy Invoice Edit Modal -->
<div
  x-data="copyEditor"
  x-show="$store.edit.showCopyModal"
  class="fixed inset-0 z-[98] flex items-center justify-center w-full h-full bg-black bg-opacity-50">
  <div class="bg-white dark:bg-vdp shadow-lg w-2/3 h-[85%] flex flex-col">
    <!-- Header -->
    <header class="flex justify-between items-center p-4 bg-vls2 dark:bg-vdp border-b border-vls/40">
      <div>
        <h2 class="text-lg font-medium text-vlp2 dark:text-vds">Edit Copy Invoice</h2>
        <p class="text-sm text-vlp2 dark:text-vds3light">
          Invoice Number:
          <span x-text="$store.edit.selectedCopy.invoice_number"></span>
        </p>
      </div>
      <div
        x-data="tooltip('Status info: paid means total - deposit = 0,\n pending means deposit attached,\n unpaid is default')">
        <button
          class="px-2 py-1 text-xs font-light border rounded-full"
          :class="{
              'border-green-500 text-green-500': $store.edit.selectedCopy.invoice_status==='paid',
              'border-yellow-500 text-yellow-500': $store.edit.selectedCopy.invoice_status==='pending',
              'border-red-500 text-red-500': $store.edit.selectedCopy.invoice_status==='unpaid'
            }"
          x-text="$store.edit.selectedCopy.invoice_status"></button>
      </div>
    </header>
    <main class="flex-grow overflow-y-auto p-4 min-h-0 h-full bg-vlp dark:bg-vdp2">
      <!-- Date Fields -->
      <section class="grid grid-cols-2 gap-4 mb-4">
        <label class="flex flex-col">
          <span class="text-sm text-vls3 dark:text-vds">Invoice Date:</span>
          <input type="date" class="modal-input-style" x-model="$store.edit.selectedCopy.date" />
        </label>
        <label class="flex flex-col">
          <span class="text-sm text-vls3 dark:text-vds">Due By:</span>
          <input type="date" class="modal-input-style" x-model="$store.edit.selectedCopy.due_date" />
        </label>
      </section>
      <!-- Deposit & Discount Editing -->
      <section class="grid grid-cols-2 gap-4 mb-4">
        <!-- Deposit Component -->
        <div
          class="p-2 rounded border border-vls/40 flex flex-col shadow dark:bg-vdp"
          x-data="{
              editable: false,
              tempDeposit: $store.edit.tempValues.deposit_value,
              displayValue() {
                return $store.edit.selectedCopy.deposit_type == 1
                  ? ('%' + $store.edit.selectedCopy.deposit_value)
                  : ('£' + $store.edit.selectedCopy.deposit_value);
              },
              activateEdit() {
                this.editable = true;
                this.$nextTick(() => { this.$refs.depositInput.focus(); });
              },
              cancelEdit() {
                this.tempDeposit = $store.edit.selectedCopy.deposit_value;
                this.editable = false;
              }
            }">
          <div class="flex items-center justify-between">
            <h3 class="font-medium text-vls3 dark:text-vds mb-2">Deposit</h3>
            <svg
              x-data="tooltip('Click deposit value to edit.')"
              class="size-4 flex place-self-start hover:brightness-125 cursor-pointer">
              <use href="/icons/icons2.xml#tool-tip" />
            </svg>
          </div>
          <!-- Fixed height container to avoid layout shifts -->
          <div class="relative h-8">
            <!-- Non-editable display -->
            <div
              x-show="!editable"
              x-transition
              class="absolute inset-0 flex items-center justify-center cursor-pointer border border-vls/40 rounded bg-blue-50 hover:bg-blue-100 dark:bg-vdp2 hover:dark:brightness-125 transition duration-200"
              @click="activateEdit()">
              <span x-text="displayValue()"></span>
            </div>
            <!-- Editable input with cancel button -->
            <div x-show="editable" x-transition class="absolute inset-0 flex items-center space-x-2">
              <input
                x-ref="depositInput"
                type="number"
                step="any"
                min="0"
                class="w-full bg-transparent border p-1 rounded text-xs focus:outline-none focus:ring-1 focus:ring-vls/60 focus:border-vls/40"
                x-model.number="tempDeposit"
                @keydown.enter="$store.edit.tempValues.deposit_value = tempDeposit; editable = false"
                :placeholder="'Original: ' + $store.edit.selectedCopy.deposit_value" />
              <button type="button" class="modal-btn-prim text-xs" @click="cancelEdit()">
                <svg class="size-4">
                  <use href="/icons/icons.svg#xmark-circle" />
                </svg>
              </button>
            </div>
          </div>
          <!-- Uniform action buttons -->
          <div class="flex justify-evenly mt-2">
            <button
              @click="$store.edit.changeDepositType(true); $store.effs.addEff($refs.rott,'spin', 500)"
              class="modal-btn-prim text-xs">
              <svg x-ref="rott" class="size-4">
                <use href="/icons/icons.svg#rotate" />
              </svg>
            </button>
            <button @click="$store.edit.removeDeposit(true)" class="modal-btn-prim text-xs">
              <svg class="size-4">
                <use href="/icons/icons.svg#trash" />
              </svg>
            </button>
            <button
              @click="$store.edit.tempValues = { ...$store.edit.tempValues, deposit_type: $store.edit.selectedCopy.deposit_type, deposit_value: tempDeposit }"
              class="modal-btn-prim text-xs">
              <svg class="size-4">
                <use href="/icons/icons.svg#check" />
              </svg>
            </button>
          </div>
        </div>
        <!-- DISCOUNT Component -->
        <div
          class="p-2 rounded border border-vls/40 flex flex-col shadow dark:bg-vdp"
          x-data="{
          editable: false,
          tempDiscount: $store.edit.tempValues.discount_value,
          displayValue() {
            return $store.edit.selectedCopy.discount_type == 1
              ? ('%' + $store.edit.selectedCopy.discount_value)
              : ('£' + $store.edit.selectedCopy.discount_value);
          },
          activateEdit() {
            this.editable = true;
            this.$nextTick(() => { this.$refs.discountInput.focus(); });
          },
          cancelEdit() {
            this.tempDiscount = $store.edit.selectedCopy.discount_value;
            this.editable = false;
          }
              }">
          <div class="flex items-center justify-between">
            <h3 class="font-medium text-vls3 dark:text-vds mb-2">Discount</h3>
            <svg
              x-data="tooltip('Click discount value to edit.')"
              class="size-4 flex place-self-start hover:brightness-125 cursor-pointer">
              <use href="/icons/icons2.xml#tool-tip" />
            </svg>
          </div>
          <div class="relative h-8">
            <!-- Non-editable display -->
            <div
              x-show="!editable"
              x-transition
              class="absolute inset-0 flex items-center justify-center cursor-pointer border border-vls/40 rounded bg-blue-50 hover:bg-blue-100 dark:bg-vdp2 hover:dark:brightness-125 transition duration-200"
              @click="activateEdit()"
              x-text="displayValue()"></div>
            <!-- Editable input with cancel button -->
            <div x-show="editable" x-transition class="absolute inset-0 flex items-center space-x-2">
              <input
                x-ref="discountInput"
                type="number"
                step="0.01"
                min="0"
                class="w-full bg-transparent border p-1 rounded text-xs focus:outline-none focus:ring-1 focus:ring-vls/60 focus:border-vls/40"
                x-model.number="tempDiscount"
                @keydown.enter="$store.edit.tempValues.discount_value = tempDiscount; editable = false"
                :placeholder="'Original: ' + $store.edit.selectedCopy.discount_value" />
              <button type="button" class="modal-btn-prim text-xs" @click="cancelEdit()">
                <svg class="size-4">
                  <use href="/icons/icons.svg#xmark-circle" />
                </svg>
              </button>
            </div>
          </div>
          <!-- Uniform action buttons -->
          <div class="flex justify-evenly mt-2">
            <button @click="$store.edit.changeDiscountType(true)" class="modal-btn-prim text-xs">
              <svg x-ref="rott" class="size-4">
                <use href="/icons/icons.svg#rotate" />
              </svg>
            </button>
            <button @click="$store.edit.removeDiscount(true)" class="modal-btn-prim text-xs">
              <svg class="size-4">
                <use href="/icons/icons.svg#trash" />
              </svg>
            </button>
            <button
              @click="$store.edit.tempValues = { ...$store.edit.tempValues, discount_value: tempDiscount }"
              class="modal-btn-prim text-xs">
              <svg class="size-4">
                <use href="/icons/icons.svg#check" />
              </svg>
            </button>
          </div>
        </div>
      </section>
      <!-- Invoice Items Table -->
      <div class="relative p-2 border rounded border-vls/40">
        <div class="relative py-0 overflow-y-auto table-scrollbar" style="max-height: 30vh">
          <table class="w-[calc(100%-10px)] table-auto border-separate px-0.5" style="border-spacing: 0 10px">
            <thead class="sticky top-0 table-head-style border-clipper">
              <tr>
                <th class="border text-left border-transparent round-left-border p-2 text-base w-[50%]">Name</th>
                <th class="p-2 text-left w-[15%]">Type</th>
                <th class="p-2 text-right w-[15%]">Qty</th>
                <th class="p-2 text-right w-[20%] round-right-border">Price</th>
              </tr>
            </thead>

            <tbody class="table-body-style table-scrollbar">
              <template x-for="item in $store.edit.selectedCopy.invoiceItems" :key="item.frontendId">
                <tr class="border-hover-ring-efect">
                  <td class="p-2 truncate round-left-border text-sm" x-text="item.name" style="width: 50%"></td>
                  <td class="p-2 text-sm" x-text="item.type" style="width: 15"></td>
                  <td class="p-2 text-right text-sm" x-text="item.quantity" style="width: 15%"></td>
                  <td
                    class="p-2 text-right round-right-border text-sm"
                    x-text="'£' + item.price"
                    style="width: 20%"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Invoice Summary -->
      <section class="my-4">
        <div class="p-2 bg-vlp dark:bg-vdp rounded border border-vls/40 shadow text-sm text-vls3 dark:text-vds">
          <h2 class="font-semibold text-base">Invoice Summary</h2>
          <div class="flex justify-between">
            <span>Subtotal:</span>
            <span x-text="'£' + $store.edit.selectedCopy.subtotal"></span>
          </div>
          <template x-if="$store.edit.selectedCopy.discount_value > 0">
            <div class="flex justify-between items-center">
              <span>Discount:</span>
              <div class="flex items-center">
                <span
                  x-text="$store.edit.selectedCopy.discount_type === 1
                    ? ($store.edit.selectedCopy.discount_value + '%')
                    : ('£' + $store.edit.selectedCopy.discount_value)"></span>
                <span
                  x-show="$store.edit.selectedCopy.discount_type === 1"
                  class="text-xs"
                  x-text="`(£${$store.edit.selectedCopy.discVal_ifPercent})`"></span>
              </div>
            </div>
          </template>
          <div class="flex justify-between">
            <span>VAT:</span>
            <span x-text="'£' + $store.edit.selectedCopy.vat"></span>
          </div>
          <div class="flex justify-between">
            <span>Total:</span>
            <span class="font-semibold" x-text="'£' + $store.edit.selectedCopy.total"></span>
          </div>
          <template x-if="$store.edit.selectedCopy.deposit_value > 0">
            <div class="flex justify-between">
              <span>Deposit:</span>
              <div class="flex items-center">
                <span
                  x-text="$store.edit.selectedCopy.deposit_type === 1
                    ? ($store.edit.selectedCopy.deposit_value + '%')
                    : ('£' + $store.edit.selectedCopy.deposit_value)"></span>
                <span
                  x-show="$store.edit.selectedCopy.deposit_type === 1"
                  class="text-xs"
                  x-text="'(£' + $store.edit.selectedCopy.depoVal_ifPercent + ')'"></span>
              </div>
            </div>
          </template>
          <div class="flex justify-between font-semibold">
            <span>Remaining:</span>
            <span x-text="'£' + $store.edit.selectedCopy.remaining"></span>
          </div>
        </div>
      </section>
      <!-- Note Section with modal -->
      <section
        class="mb-4"
        x-data="{ showNoteModal: false, noteText: $store.edit.tempValues.note || $store.edit.selectedCopy.note || '' }">
        <div class="p-4 bg-vlp dark:bg-vdp rounded border border-vls/40 shadow text-sm flex justify-between">
          <div class="h-[2rem]">
            <span class="font-medium text-vls3 dark:text-vds">Note:</span>
            <span
              class="text-xs text-vls2 dark:text-vds3light"
              x-text="$store.edit.tempValues.note ? 'Note: ' + $store.edit.tempValues.note : 'No note added'"></span>
          </div>
          <div class="flex items-center gap-2">
            <button @click="showNoteModal = true" class="modal-btn-prim text-xs flex items-center">
              <svg class="w-4 h-4">
                <use href="/icons/icons.svg#pencil" />
              </svg>
            </button>
            <button
              x-show="noteText.length > 0 && !showNoteModal"
              x-transition
              @click="noteText = ''; $store.edit.tempValues.note = ''; showNoteModal = false"
              class="modal-btn-sec text-xs flex items-center">
              <svg class="w-4 h-4">
                <use href="/icons/icons.svg#trash" />
              </svg>
            </button>
          </div>
        </div>
        <template x-if="showNoteModal">
          <div class="fixed inset-0 z-[99] flex items-center justify-center bg-black bg-opacity-50">
            <div class="bg-white dark:bg-vdp rounded shadow-lg p-4 w-1/2">
              <h3 class="font-medium mb-2">Invoice Note</h3>
              <textarea
                x-model="noteText"
                maxlength="220"
                placeholder="Enter note (max 220 chars)"
                class="modal-input-style p-1 w-full alt-table-scrollbar"
                style="height: 12vh; resize: none"
                rows="3"></textarea>
              <div class="flex justify-between mt-4">
                <button @click="showNoteModal = false" class="modal-btn-sec text-xs mr-2">Cancel</button>
                <button
                  @click="$store.edit.tempValues.note = noteText; showNoteModal = false"
                  class="modal-btn-prim text-xs">
                  Save Note
                </button>
              </div>
            </div>
          </div>
        </template>
      </section>
      <!-- Footer Action Buttons -->
    </main>
    <footer class="flex justify-between items-center p-4 bg-vls2 dark:bg-vdp border-t border-vls/40">
      <button @click="$store.edit.cancelCopyEdit()" class="modal-btn-sec text-xs">Cancel</button>
      <button @click="$store.edit.cancelCopyEdit()" class="modal-btn-sec text-xs">PDF</button>
      <button @click="$store.edit.saveCopyEdit()" class="modal-btn-prim text-xs">Save</button>
    </footer>
  </div>
</div>
