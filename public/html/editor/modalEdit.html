<div x-data="modalEdit">
  <template x-if="$store.edit.openEditModal">
    <div class="fixed inset-0 z-[99] flex items-center justify-center bg-black bg-opacity-50">
      <!-- Modal Container -->
      <div
        class="bg-white p-6 rounded border border-vls/40 shadow-lg w-[90%] max-h-[90%] overflow-y-auto relative dark:bg-vdp2">
        <h1 class="self-center justify-center text-xl font-medium text-vls2 dark:text-vds flex w-full mb-2">
          <span x-text="'Edit Invoice – ' + $store.edit.invoiceItems.invoice.invoice_number"></span>
        </h1>
        <hr class="border-vls/40" />
        <!-- SECTION 1: Existing Items for Client -->
        <div>
          <h2
            class="my-4 font-medium text-lg text-center dark:text-vds self-center text-vls2"
            x-text="`${$store.clients.selectedClient?.name}'s styles and samples`"></h2>
          <div class="flex flex-col items-center justify-center w-full">
            <!-- Search Input (outside scrollable container) -->
            <div class="w-full flex justify-center">
              <input
                type="text"
                placeholder="Search items..."
                x-transition
                class="w-1/2 p-1 border rounded mb-2 srch-style text-center"
                x-model="$store.edit.existingItems.searchQuery" />
            </div>
          </div>
          <!-- Container 30% of modal height -->
          <div class="relative p-2 border rounded border-vls/40">
            <div class="relative py-0 overflow-y-auto table-scrollbar" style="max-height: 30vh">
              <table class="w-[calc(100%-10px)] table-auto border-separate px-0.5" style="border-spacing: 0 10px">
                <thead class="sticky top-0 table-head-style border-clipper text-base">
                  <tr>
                    <th class="border text-left border-transparent round-left-border p-2 text-base w-[50%]">Name</th>
                    <th class="p-2 text-left w-[10%]">Type</th>
                    <th class="text-right w-[10%]">Price</th>
                    <th class="text-right w-[15%]">
                      Time
                      <span class="text-xs">(min)</span>
                    </th>
                    <th class="text-center w-[15%] round-right-border">Actions</th>
                  </tr>
                </thead>
                <tbody class="table-body-style table-scrollbar">
                  <template
                    x-for="item in $store.edit.existingItems.filteredItems"
                    :key="`client-${item.type}-${item.id}`">
                    <tr :id="`existing-${item.id}-${item.type}`" class="border-hover-ring-efect">
                      <td class="text-sm p-1.5 truncate round-left-border w-[50%]" x-text="item.name"></td>
                      <td class="text-left text-sm w-[10%]" x-text="item.type"></td>
                      <td class="text-right text-sm w-[10%]" x-text="'£' + item.price.toFixed(2)"></td>
                      <td
                        class="text-right text-sm w-[15%]"
                        x-text="item.type === 'sample' ? item.time + ' min' : 'N/A'"></td>
                      <td class="w-[15%]">
                        <div class="flex items-center justify-center w-full">
                          <button
                            @click="$store.edit.addDropdownItem(item); $nextTick(() => $store.invo.addItemAnimation(`existing-${item.id}-${item.type}`))"
                            class="mx-1 table-interaction-icon-blue">
                            <svg class="size-5"><use href="/icons/icons.svg#plus-circle" /></svg>
                          </button>
                          <input
                            type="number"
                            min="1"
                            class="w-14 h-full table-input-standard"
                            x-model.number="item.quantity" />
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
          <!-- SECTION 2: Current Invoice Items -->
          <div>
            <h2
              class="my-4 font-medium text-lg text-center dark:text-vds self-center text-vls2"
              x-text="`${$store.edit.invoiceItems.invoice.invoice_number}'s items`"></h2>
            <!-- Outer container is limited to 30% of the modal height -->
            <div class="relative p-2 border rounded border-vls/40">
              <div class="relative py-0 overflow-y-auto table-scrollbar" style="max-height: 30vh">
                <table class="w-[calc(100%-10px)] table-auto border-separate px-0.5" style="border-spacing: 0 10px">
                  <thead class="sticky top-0 table-head-style border-clipper text-base">
                    <tr>
                      <th class="border text-left border-transparent round-left-border p-2 text-base w-[35%]">Name</th>
                      <th class="p-2 text-left w-[10%]">Type</th>
                      <th class="p-2 text-right w-[10%]">Qty</th>
                      <th class="text-right w-[10%]">
                        Price
                        <span class="text-xs">(total)</span>
                      </th>
                      <th class="text-center w-[15%] round-right-border">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="table-body-style table-scrollbar">
                    <template x-for="item in $store.edit.invoiceItems.invoiceItems" :key="item.frontendId">
                      <tr :id="`current-${item.id}-${item.frontendId}`" class="border-hover-ring-efect">
                        <td class="text-sm p-1.5 truncate round-left-border w-[35%]" x-text="item.name"></td>
                        <td class="text-left text-sm w-[10%]" x-text="item.type"></td>
                        <td class="text-right text-sm w-[10%]" x-text="item.quantity"></td>
                        <td
                          class="text-right text-sm w-[10%]"
                          x-text="item.type === 'sample'
                            ? ('£' + (item.price * (item.time / 60) * item.quantity).toFixed(2))
                            : ('£' + (item.price * item.quantity).toFixed(2))"></td>
                        <td class="w-[15%]">
                          <div class="flex items-center justify-center w-full space-x-2">
                            <button
                              @click="$store.edit.incrementInvoiceItem(item.frontendId); $nextTick(() => $store.invo.addItemAnimation(`current-${item.id}-${item.frontendId}`))"
                              class="table-interaction-icon-blue">
                              <svg class="size-5"><use href="/icons/icons.svg#plus-circle" /></svg>
                            </button>
                            <button
                              @click="$store.edit.decrementInvoiceItem(item.frontendId);"
                              class="table-interaction-icon-red">
                              <svg class="size-5"><use href="/icons/icons.svg#minus-circle" /></svg>
                            </button>
                            <button
                              @click="$store.edit.removeInvoiceItem(item.frontendId);"
                              class="table-interaction-icon-red">
                              <svg class="size-5"><use href="/icons/icons.svg#trash" /></svg>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 3: Custom Item Inputs -->
        <div>
          <p class="my-4 font-medium text-xl text-center dark:text-vds self-center text-vls2">Add Custom Item</p>
          <hr class="border-vls/40" />
          <div class="flex items-center py-4 px-2 justify-center w-full">
            <div class="flex w-[25%] justify-center">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" value="style" x-model="$store.edit.newItem.type" class="form-radio mr-1.5" />
                <span>Style</span>
              </label>
            </div>
            <div class="flex w-[25%] justify-center">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" value="sample" x-model="$store.edit.newItem.type" class="form-radio mr-1.5" />
                <span>Sample</span>
              </label>
            </div>
          </div>
          <div x-show="$store.edit.newItem.type" x-transition class="flex flex-col items-center justify-center">
            <div class="flex gap-4">
              <input type="text" x-model="$store.edit.newItem.name" placeholder="Item Name" class="modal-input-style" />
              <template x-if="$store.edit.newItem.type === 'sample'">
                <input
                  type="number"
                  step="0.01"
                  x-model.number="$store.edit.newItem.time"
                  placeholder="Time (minutes)"
                  class="modal-input-style" />
              </template>
              <input
                type="number"
                step="0.01"
                x-model.number="$store.edit.newItem.price"
                placeholder="Price"
                class="modal-input-style" />
              <input
                type="number"
                min="1"
                x-model.number="$store.edit.newItem.quantity"
                placeholder="Quantity"
                class="modal-input-style" />
            </div>
            <button @click="$store.edit.addCustomItem()" class="modal-btn-prim my-4 flex items-center">
              <svg class="w-4 h-4 mr-1"><use href="/icons/icons.svg#plus-circle" /></svg>
              Add Custom Item
            </button>
          </div>
          <hr class="border-vls/40" />
        </div>
        <section class="grid grid-cols-2 gap-4 my-4">
          <!-- Deposit Component -->
          <div class="p-2 rounded border border-vls/40 shadow dark:bg-vdp flex justify-between">
            <!-- Deposit -->
            <div class="w-1/2 relative mr-4">
              <span class="absolute top-0 left-0 text-sm text-gray-500">Deposit:</span>
              <div class="mt-6">
                <div class="relative">
                  <input
                    id="depositInputEdit"
                    x-ref="depoInput"
                    x-model.number="$store.edit.uiDeposit"
                    :placeholder="$store.edit.invoiceItems.invoice.deposit_type === 0 ? '£'+$store.edit.invoiceItems.invoice.deposit_value : $store.edit.invoiceItems.invoice.deposit_value + '%'"
                    class="mod-input" />
                  <span class="absolute right-1/2 top-1/2 transform -translate-y-1/2 text-base">
                    <span x-text="$store.edit.invoiceItems.invoice.deposit_type === 1 ? '%' : '£'"></span>
                  </span>
                  <div class="absolute inset-y-0 right-0 flex items-center pr-2 space-x-1">
                    <!-- Trash Button -->
                    <button
                      @click="$store.edit.removeDeposit();"
                      class="table-interaction-icon-red !text-vls2 hover:!text-red-500 dark:!text-vds3light dark:hover:!text-red-500">
                      <svg class="size-4">
                        <use href="/icons/icons.svg#trash" />
                      </svg>
                    </button>
                    <!-- Edit Button -->
                    <button
                      @click="$store.edit.changeDepositType(); $store.effs.addEff($refs.rotateDepo, 'spin', 500); $nextTick(() => { $refs.depoInput.focus() });"
                      class="table-interaction-icon-red !text-vls2 hover:!text-orange-500 dark:!text-vds3light dark:hover:!text-orange-500">
                      <svg x-ref="rotateDepo" class="size-4">
                        <use href="/icons/icons.svg#rotate" />
                      </svg>
                    </button>
                    <!-- Check Button -->
                    <button
                      @click="$store.edit.addDeposit()"
                      class="table-interaction-icon-red !text-vls2 hover:!text-vla2 dark:!text-vds3light dark:hover:!text-vla2">
                      <svg class="size-4">
                        <use href="/icons/icons.svg#check-circle" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="w-1/2 relative">
              <span class="absolute top-0 left-0 text-sm text-gray-500">Discount:</span>
              <div class="mt-6">
                <div class="relative">
                  <input
                    id="discountInputEdit"
                    x-ref="discInputEdit"
                    x-model.number="$store.edit.uiDiscount"
                    :placeholder="$store.edit.invoiceItems.invoice.discount_type === 0 ? '£'+$store.edit.invoiceItems.invoice.discount_value : $store.edit.invoiceItems.invoice.discount_value + '%'"
                    class="mod-input" />
                  <span class="absolute right-1/2 top-1/2 transform -translate-y-1/2 text-base">
                    <span x-text="$store.edit.invoiceItems.invoice.discount_type === 1 ? '%' : '£'"></span>
                  </span>
                  <div class="absolute inset-y-0 right-0 flex items-center pr-2 space-x-1">
                    <!-- Trash Button -->
                    <button
                      @click="$store.edit.removeDiscount();"
                      class="table-interaction-icon-red !text-vls2 hover:!text-red-500 dark:!text-vds3light dark:hover:!text-red-500">
                      <svg class="size-4">
                        <use href="/icons/icons.svg#trash" />
                      </svg>
                    </button>
                    <!-- Edit Button -->
                    <button
                      @click="$store.edit.changeDiscountType(); $store.effs.addEff($refs.rotateDisc, 'spin', 500); $nextTick(() => { $refs.discInputEdit.focus() });"
                      class="table-interaction-icon-red !text-vls2 hover:!text-orange-500 dark:!text-vds3light dark:hover:!text-orange-500">
                      <svg x-ref="rotateDisc" class="size-4">
                        <use href="/icons/icons.svg#rotate" />
                      </svg>
                    </button>
                    <!-- Check Button -->
                    <button
                      @click="$store.edit.addDiscount()"
                      class="table-interaction-icon-red !text-vls2 hover:!text-vla2 dark:!text-vds3light dark:hover:!text-vla2">
                      <svg class="size-4">
                        <use href="/icons/icons.svg#check-circle" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Discount Component -->
          <div class="p-2 rounded border border-vls/40 shadow dark:bg-vdp flex justify-between">
            <!-- Date -->
            <div class="w-1/2 relative mr-4">
              <span class="absolute top-0 left-0 text-sm text-gray-500">Date issued:</span>
              <div x-data="{}" class="mt-6">
                <input
                  x-ref="dueDateInput"
                  type="text"
                  x-init="
                    $store.datePicker.createNew(
                      $refs.dueDateInput,
                      'edit',
                      'invoiceItems.invoice.date'
                    )
                  "
                  class="mod-input" />
              </div>
            </div>
            <!-- Due By Date -->
            <div class="w-1/2 relative">
              <span class="absolute top-0 left-0 text-sm text-gray-500">Due by date:</span>
              <div x-data="{}" class="mt-6">
                <input
                  x-ref="dueDateInput"
                  type="text"
                  x-init="
                    $store.datePicker.createNew(
                      $refs.dueDateInput,
                      'edit',
                      'invoiceItems.invoice.due_by_date'
                    )
                  "
                  class="mod-input" />
              </div>
            </div>
          </div>
        </section>
        <!-- SECTION 4: Invoice Summary and Cancel/Save Buttons -->
        <div class="flex mt-4">
          <div
            class="w-[40%] flex flex-col gap-2 p-4 mr-2 bg-vlp dark:bg-vdp rounded border border-vls/40 shadow-md text-vls3 dark:text-vds text-sm">
            <div class="flex flex-col gap-2">
              <h2 class="font-semibold text-base">Invoice Summary</h2>
              <div class="flex justify-between">
                <span>Subtotal:</span>
                <span x-text="'£' + $store.edit.invoiceItems.invoice.subtotal_pre_discount"></span>
              </div>
              <template x-if="$store.edit.invoiceItems.invoice.discount_value > 0">
                <div class="flex justify-between items-center">
                  <span>Discount:</span>
                  <div class="flex items-center">
                    <span
                      x-text="$store.edit.invoiceItems.invoice.discount_type === 1
                    ? ($store.edit.invoiceItems.invoice.discount_value + '%')
                    : ('£' + $store.edit.invoiceItems.invoice.discount_value)"></span>
                    <span
                      x-show="$store.edit.invoiceItems.invoice.discount_type === 1"
                      class="text-xs"
                      x-text="`(£${$store.edit.invoiceItems.invoice.discVal_ifPercent})`"></span>
                    <button
                      @click="$store.edit.removeDiscount(); $store.edit.modDisc = false"
                      class="text-red-600 hover:text-red-500">
                      <svg class="ml-1 w-4 h-4"><use href="/icons/icons.svg#trash" /></svg>
                    </button>
                  </div>
                </div>
              </template>
              <div class="flex justify-between">
                <span>VAT:</span>
                <span x-text="'£' + $store.edit.invoiceItems.invoice.vat"></span>
              </div>
              <div class="flex justify-between">
                <span>Total:</span>
                <span class="font-semibold" x-text="'£' + $store.edit.invoiceItems.invoice.total"></span>
              </div>
              <template x-if="$store.edit.invoiceItems.invoice.deposit_value > 0">
                <div class="flex justify-between items-center">
                  <span>Deposit:</span>
                  <div class="flex items-center">
                    <span
                      x-text="$store.edit.invoiceItems.invoice.deposit_type === 1
                    ? ($store.edit.invoiceItems.invoice.deposit_value + '%')
                    : ('£' + $store.edit.invoiceItems.invoice.deposit_value)"></span>
                    <span
                      x-show="$store.edit.invoiceItems.invoice.deposit_type === 1"
                      class="text-xs"
                      x-text="`(£${$store.edit.invoiceItems.invoice.depoVal_ifPercent})`"></span>
                    <button
                      @click="$store.edit.removeDeposit(); $store.edit.modDepo = false"
                      class="text-red-600 hover:text-red-500">
                      <svg class="ml-1 w-4 h-4"><use href="/icons/icons.svg#trash" /></svg>
                    </button>
                  </div>
                </div>
              </template>
              <div class="flex justify-between font-semibold">
                <span>Remaining:</span>
                <span x-text="'£' + $store.edit.invoiceItems.invoice.remaining"></span>
              </div>
            </div>
          </div>
          <!-- Cancel / Save Buttons -->
          <div
            class="flex w-[70%] px-4 bg-vlp rounded border-vls/60 border text-vls3 dark:bg-vdp dark:text-vds dark:border-vls/40 shadow-md dark:shadow flex-col items-end justify-end gap-4 py-2">
            <div class="flex items-end justify-between gap-2 w-full mb-0.5">
              <div x-data="tooltip('Close modal and revert any changes', { position: 'top' })">
                <button @click="$store.edit.exitEditMode();" class="btn-sec">Cancel</button>
              </div>
              <div class="flex gap-4">
                <div
                  x-data="tooltip('Made a mistake? \n Overwrite the current invoice\nwith changes in this modal.', { position: 'top' })">
                  <button @click="$store.edit.saveEdit({mode: 'overwrite'})" class="modal-btn-prim flex items-center">
                    <svg class="w-4 h-4"><use href="/icons/icons.svg#rotate" /></svg>
                    Overwrite
                  </button>
                </div>
                <div
                  x-data="tooltip('Ready to issue a deposit or send\n a follow up invoice? \n This saves a copy in your invoice book\n with a follow up number.\n Must contain deposit to use.', { position: 'top' })">
                  <div
                    @click="if ($store.edit.invoiceItems.invoice.deposit_value <= 0) {
                        callInfo('Cannot save a copy', 'Invoice must contain a deposit.');
                        return;
                    } else {
                        $store.edit.saveEdit({ mode: 'copy' })
                    }"
                    class="modal-btn-prim flex items-center"
                    :class="{ 'opacity-50 cursor-not-allowed': $store.edit.invoiceItems.invoice.deposit_value <= 0 }">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="size-4">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
                    </svg>
                    Save a Copy
                  </div>
                </div>
                <div
                  x-data="tooltip('Mark this invoice as fully paid in the invoice book.\n Remaining balance must be 0 to mark as paid.', { position: 'top' })">
                  <div
                    @click="if ($store.edit.invoiceItems.invoice.remaining !== 0) {
                  callInfo('Cannot mark as complete', 'Remaining balance must be 0.');
                  return;
                } else {
                  $store.edit.saveEdit({ mode: 'paid' })
                }"
                    class="modal-btn-prim flex items-center"
                    :class="{ 'opacity-50 cursor-not-allowed': $store.edit.invoiceItems.invoice.remaining !== 0 }">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="size-4">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M14.121 7.629A3 3 0 0 0 9.017 9.43c-.023.212-.002.425.028.636l.506 3.541a4.5 4.5 0 0 1-.43 2.65L9 16.5l1.539-.513a2.25 2.25 0 0 1 1.422 0l.655.218a2.25 2.25 0 0 0 1.718-.122L15 15.75M8.25 12H12m9 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Mark as Paid
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <section
          class="my-4"
          x-data="{ showNoteModal: false, noteText: $store.edit.invoiceItems.invoice.note || $store.edit.invoiceItems.invoice.note || '' }">
          <div class="p-4 bg-vlp dark:bg-vdp rounded border border-vls/40 shadow text-sm flex justify-between">
            <div class="h-[2rem]">
              <span class="font-medium text-vls3 dark:text-vds">Note:</span>
              <span
                class="text-xs text-vls2 dark:text-vds3light"
                x-text="$store.edit.invoiceItems.invoice.note ? $store.edit.invoiceItems.invoice.note : 'No note added'"></span>
            </div>
            <div class="flex items-center gap-2">
              <button @click="showNoteModal = true" class="modal-btn-prim text-xs flex items-center">
                <svg class="w-4 h-4">
                  <use href="/icons/icons.svg#pencil" />
                </svg>
              </button>
              <button
                x-show="noteText.length > 0 && !showNoteModal"
                x-transition
                @click="noteText = ''; $store.edit.invoiceItems.invoice.note = ''; showNoteModal = false"
                class="modal-btn-sec text-xs flex items-center">
                <svg class="w-4 h-4">
                  <use href="/icons/icons.svg#trash" />
                </svg>
              </button>
            </div>
          </div>
          <template x-if="showNoteModal">
            <div class="fixed inset-0 z-[99] flex items-center justify-center bg-black bg-opacity-50">
              <div class="bg-white dark:bg-vdp rounded shadow-lg p-4 w-1/2">
                <h3 class="font-medium mb-2">Invoice Note</h3>
                <textarea
                  x-model="noteText"
                  maxlength="220"
                  placeholder="Enter note (max 220 chars)"
                  class="modal-input-style p-1 w-full alt-table-scrollbar"
                  style="height: 12vh; resize: none"
                  rows="3"></textarea>
                <div class="flex justify-between mt-4">
                  <button @click="showNoteModal = false" class="btn-sec">Cancel</button>

                  <button
                    @click="$store.edit.invoiceItems.invoice.note = noteText; showNoteModal = false"
                    class="modal-btn-prim text-xs">
                    Save Note
                  </button>
                </div>
              </div>
            </div>
          </template>
        </section>
      </div>
    </div>
  </template>
</div>
